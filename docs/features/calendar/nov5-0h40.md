Chuẩn rồi—với **Firebase hiện tại mới chỉ đăng nhập**, để “tạo riêng calendar cho từng Project” và để Google tự nhắc lịch, bạn cần **thêm OAuth 3-legged của Google (Calendar scopes)** cho **chính người dùng**. Service account của Firebase không truy cập được lịch cá nhân trừ khi bạn dùng Google Workspace + ủy quyền toàn miền (không hợp ngữ cảnh B2C).

Dưới đây là **playbook không code** (logic/flow rõ ràng) để bạn ghép vào Plantracker (NestJS + Android):

---

# A) Chuẩn bị 1 lần trên Google Cloud (không code)

1. **Tạo/Chọn Google Cloud Project** (GCP) cho app.
2. **Enable APIs**: Google Calendar API.
3. **OAuth consent screen**:

   * App type: External.
   * Scopes tối thiểu:

     * `.../auth/calendar.events` (đọc/ghi sự kiện)
     * `.../auth/calendar` (tạo/xoá Calendar – khuyến nghị bật)
   * Thêm test users (trước khi “Publish”).
4. **Tạo OAuth Client**:

   * Nếu bạn mở consent qua web trong app: tạo **Web client** (redirect về backend).
   * Nếu muốn thực hiện từ Android: tạo **Android client** (và vẫn cần backend exchange token).

> Kết quả: bạn có client_id/secret (cho web) hoặc cấu hình Android. Chưa cần động tới service key Firebase.

---

# B) Kiến trúc tích hợp trong Plantracker (module & dữ liệu)

## 1) Modules thêm vào backend (NestJS)

**1. GoogleAuthIntegrationModule**

* Mục tiêu: xin **consent** và lưu **refresh token** theo user.
* Luồng:

  1. Người dùng bấm “Connect Google Calendar” trong Plantracker.
  2. Backend redirect tới trang consent của Google (scopes trên).
  3. Google trả `code` về endpoint callback → backend **exchange** lấy `access_token + refresh_token + expiry`.
  4. Lưu vào DB (bảng `user_integrations`).

**2. CalendarProvisioningModule**

* Mục tiêu: **tạo calendar riêng cho Project** (hoặc dùng Primary nếu user chọn).
* Luồng khi user bật tích hợp cho 1 Project:

  1. Lấy tokens của user từ `user_integrations`.
  2. Gọi **Calendars.insert** để tạo: *“Plantracker – <Project>”* (timeZone: `Asia/Ho_Chi_Minh`).
  3. Gọi **CalendarList.patch/insert** đặt `defaultReminders` (ví dụ popup 30’).
  4. Lưu `calendarId` vào bảng `projects` + policy (PROJECT_CAL vs PRIMARY).

**3. TaskCalendarSyncModule**

* Mục tiêu: **đẩy sự kiện 1 chiều** vào calendar đã chọn.
* Khi Task có `dueDate` → tạo/ cập nhật **all-day event** (start.date = D, end.date = D+1, reminders dùng default).
* Khi Task có giờ (focus/meeting) → tạo/ cập nhật **time-bound event** (start/end dateTime +07:00, reminders overrides nếu cần).
* Lưu `calendarEventId` vào `tasks` để idempotent (upsert, xoá).

**4. MeetingOrFocusModule**

* Mục tiêu: từ Task → tạo **meeting** (attendees + Meet link) hoặc **focus block** (không attendees).
* Meeting: thêm danh sách email (assignee/reviewer) làm `attendees`, yêu cầu `conferenceData` để có Google Meet.
* Focus: chỉ block giờ + nhắc trước 10’/1’.

> Giai đoạn này **không làm 2 chiều** và **không cần cron**. Nếu sau này muốn 2 chiều (kéo thả trên Calendar cập nhật Task), mới thêm `CalendarWatchModule` dùng push webhook (cũng không cron).

## 2) Bổ sung schema dữ liệu (ý tưởng)

* `user_integrations`: `provider (GOOGLE)`, `accessToken`, `refreshToken`, `tokenExpiry`, `scopes`.
* `projects`: `calendarId`, `calendarPolicy (PROJECT_CAL|PRIMARY|USER_SELECT)`, `defaultReminderMinutes`.
* `tasks`: `calendarEventId`, `eventType (DUE|FOCUS|MEETING)`, `eventStart`, `eventEnd`, `eventStatus (SYNCED|DELETED|ORPHAN)`.

---

# C) Scenarios cụ thể (không code, từng bước)

## Scenario 1 — Kết nối Google Calendar cho tài khoản

1. User mở **Settings → Integrations** trong Plantracker → bấm **Connect Google Calendar**.
2. Bạn mở **OAuth consent** (scopes: calendar, calendar.events).
3. Sau khi user “Allow”, backend lưu refresh token vào `user_integrations`.
4. UI hiển thị trạng thái: “Google Calendar: Connected”.

**Kiểm tra bạn đã làm gì:** Hiện bạn **chưa có OAuth 3-legged** → cần thêm **bước consent này**. Firebase login **không** thay thế được.

---

## Scenario 2 — Bật tích hợp Calendar cho một Project

1. Vào Project → tab **Calendar** → chọn **Use separate calendar (recommended)**.
2. Backend gọi **Calendars.insert** tạo “Plantracker – <Project>”, set timeZone + default reminders (30’).
3. Lưu `calendarId` vào `projects`.
4. (Tuỳ chọn) Cho phép user bật loại nào sẽ sync: **Due** (on), **Meeting** (on), **Focus block** (off).

**So với Jira/Trello:** đa số platform chọn **calendar riêng theo Board/Project** làm mặc định.

---

## Scenario 3 — Đồng bộ Due date (all-day)

1. User đặt/đổi `dueDate` cho Task.
2. `TaskCalendarSyncModule`:

   * Nếu chưa có `calendarEventId` → tạo **all-day event** vào `projects.calendarId`.
   * Nếu đã có → cập nhật ngày.
   * `summary`: `[<PROJECT>] DUE: #<ISSUEKEY> <Task title>`
   * `description`: deep link `plantracker://task/<id>` + tóm tắt checklist (không bỏ dữ liệu nhạy cảm).
3. Google Calendar **tự nhắc** theo default reminder. **Không cần cron**.

---

## Scenario 4 — Lên lịch Meeting review từ Task

1. User chọn “Schedule Review” trong Task, nhập khung giờ + người tham gia.
2. `MeetingOrFocusModule` tạo **event có giờ** với `attendees` và **Meet link**; `reminders` có thể 10’/1’.
3. Calendar gửi mời + nhắc lịch tự động.
4. Lưu `calendarEventId` để sau này sửa/xoá.
Note: chỉnh sửa thành: từ tab event trong project -> tạo event meeting hoặc g
---

## Scenario 5 — Focus block cá nhân từ Task

1. User chọn “Add Focus Block” và đặt 1-2 slot trong ngày.
2. Tạo event có giờ (không attendees), nhắc 10’ trước.
3. Nếu slot trùng họp khác, chỉ **cảnh báo trong UI**, không chặn.

---

## Scenario 6 — Đóng/Xoá Task

* Khi Task sang `Done`:

  * Chính sách Project: **giữ event** (đổi tiêu đề thêm `[DONE]`) **hoặc** xoá event.
* Khi Task bị xoá: xoá event nếu còn link, dọn `calendarEventId`.

---

# D) Quy tắc & chính sách (để chạy mượt)

* **Mặc định dùng calendar riêng theo Project** (có thể cho phép user chuyển sang Primary nếu muốn).
* **Không dùng service account** để đẩy vào lịch cá nhân: không khả thi trong B2C.
* **Timezone**: lưu UTC trong DB, khi tạo event ghi `+07:00` để hiển thị đúng cho user VN.
* **Quyền/Privacy**: nếu Task private, description chỉ chứa tiêu đề + deep link, không lộ nội dung.
* **Idempotent**: luôn lưu `calendarEventId` để update/xoá chuẩn; tránh tạo trùng.
* **Không cron**: mọi nhắc lịch do Google Calendar xử lý; bạn chỉ đồng bộ sự kiện.

---

## Xác nhận nhanh (để mình tinh chỉnh tiếp)

* Ok chốt: **calendar riêng theo Project** làm mặc định nhé?
* Bạn đồng ý **thêm bước OAuth consent** (3-legged) bên cạnh Firebase login?
* Với Project hiện tại, bạn muốn bật sync mặc định cho **Due** và **Meeting**, còn **Focus** để user tự chọn—đúng không?

Nếu đúng, mình sẽ viết **đặc tả endpoint + field mapping chi tiết** (chỉ logic, không code) cho 4 module ở trên để bạn chuyển dev triển khai thẳng.
