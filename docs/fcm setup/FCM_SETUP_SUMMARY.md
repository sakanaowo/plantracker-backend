# üì± FCM SETUP - QUICK SUMMARY

## üéØ T√ìM T·∫ÆT NHANH

### **ANDROID CLIENT C·∫¶N:**

#### 1. **Permissions trong AndroidManifest.xml:**
```xml
‚úÖ INTERNET - B·∫Øt bu·ªôc
‚úÖ POST_NOTIFICATIONS - B·∫Øt bu·ªôc (Android 13+)
‚úÖ WAKE_LOCK - Recommended
‚ö†Ô∏è VIBRATE - Optional
```

#### 2. **Dependencies trong build.gradle:**
```groovy
‚úÖ Firebase BoM
‚úÖ Firebase Messaging
‚úÖ Firebase Analytics (optional)
‚úÖ Retrofit (ƒë·ªÉ g·ªçi API backend)
```

#### 3. **Firebase Configuration:**
```
‚úÖ google-services.json (download t·ª´ Firebase Console)
‚úÖ Paste v√†o th∆∞ m·ª•c app/
```

#### 4. **Implement FirebaseMessagingService:**
```kotlin
‚úÖ onNewToken() - G·ª≠i token l√™n backend
‚úÖ onMessageReceived() - Handle notifications
```

#### 5. **Notification Channels (Android 8.0+):**
```kotlin
‚úÖ task_updates
‚úÖ task_comments  
‚úÖ mentions
‚úÖ meeting_reminders
‚úÖ event_invites
‚úÖ system
```

#### 6. **Request Permission (Android 13+):**
```kotlin
‚úÖ POST_NOTIFICATIONS runtime permission
‚úÖ Show rationale n·∫øu user t·ª´ ch·ªëi
```

#### 7. **Get FCM Token v√† g·ª≠i l√™n Backend:**
```kotlin
FirebaseMessaging.getInstance().token.addOnSuccessListener { token ->
    // Call API: POST /api/notifications/register-device
}
```

---

### **BACKEND C·∫¶N:**

#### 1. **Endpoints c·∫ßn implement:**

```typescript
‚úÖ POST   /api/notifications/register-device
   Body: { fcmToken, platform, deviceName, osVersion }
   Purpose: ƒêƒÉng k√Ω device khi user login

‚úÖ POST   /api/notifications/update-token
   Body: { deviceId, newFcmToken }
   Purpose: Update token khi Firebase refresh

‚úÖ DELETE /api/notifications/devices/:deviceId
   Purpose: X√≥a device khi user logout

‚úÖ GET    /api/notifications/devices
   Purpose: L·∫•y danh s√°ch devices c·ªßa user

‚úÖ GET    /api/notifications?page=1&limit=20&unreadOnly=false
   Purpose: L·∫•y notifications v·ªõi pagination

‚úÖ PATCH  /api/notifications/mark-read
   Body: { notificationIds: ["uuid1", "uuid2"] }
   Purpose: ƒê√°nh d·∫•u notifications ƒë√£ ƒë·ªçc

‚úÖ PATCH  /api/notifications/mark-all-read
   Body: { beforeDate?: "2025-10-24T..." }
   Purpose: ƒê√°nh d·∫•u t·∫•t c·∫£ notifications ƒë√£ ƒë·ªçc

‚úÖ DELETE /api/notifications/:id
   Purpose: X√≥a notification

‚úÖ GET    /api/notifications/stats
   Purpose: Get th·ªëng k√™ notifications (total, unread, byType)
```

#### 2. **NotificationsService methods:**

```typescript
‚úÖ registerDevice(userId, dto) - Register FCM token
‚úÖ updateFCMToken(userId, dto) - Update token
‚úÖ unregisterDevice(userId, deviceId) - Remove device
‚úÖ getUserDevices(userId) - Get devices
‚úÖ getUserNotifications(userId, options) - Get notifications
‚úÖ markNotificationsAsRead(userId, dto) - Mark read
‚úÖ markAllNotificationsAsRead(userId, beforeDate) - Mark all read
‚úÖ deleteNotification(userId, notificationId) - Delete
‚úÖ getNotificationStats(userId) - Get stats
```

#### 3. **FCM Service updates:**

```typescript
‚úÖ validateToken(fcmToken) - Validate token v·ªõi Firebase
‚úÖ sendNotification(payload) - Send to single device
‚úÖ sendToMultipleDevices(tokens, ...) - Send to multiple devices
```

#### 4. **DTOs c·∫ßn t·∫°o:**

```typescript
‚úÖ RegisterDeviceDto
‚úÖ UpdateTokenDto
‚úÖ MarkReadDto
‚úÖ MarkAllReadDto
‚úÖ DeviceResponseDto
```

---

## üîÑ FLOW HO·∫†T ƒê·ªòNG

### **1. User Login (Android App):**

```
Android App
    ‚Üì
Request POST_NOTIFICATIONS permission (Android 13+)
    ‚Üì
FirebaseMessaging.getInstance().token
    ‚Üì
Call API: POST /api/notifications/register-device
    {
      fcmToken: "eXAMPLE_TOKEN",
      platform: "ANDROID",
      deviceName: "Samsung Galaxy S23",
      osVersion: "Android 14"
    }
    ‚Üì
Backend validates token with Firebase
    ‚Üì
Save to user_devices table
    ‚Üì
Return deviceId to Android
```

### **2. Notification Sent (Backend ‚Üí Android):**

```
Backend Event (e.g., task assigned)
    ‚Üì
NotificationsService.sendTaskAssigned()
    ‚Üì
Get FCM tokens from user_devices table
    ‚Üì
FCMService.sendNotification()
    ‚Üì
Firebase Cloud Messaging
    ‚Üì
Android FirebaseMessagingService.onMessageReceived()
    ‚Üì
Show notification in system tray
    ‚Üì
User clicks ‚Üí Open app with intent
```

### **3. Token Refresh (Firebase automatically):**

```
Firebase SDK detects token changed
    ‚Üì
FirebaseMessagingService.onNewToken(token)
    ‚Üì
Call API: POST /api/notifications/update-token
    {
      deviceId: "saved-device-id",
      newFcmToken: "NEW_TOKEN"
    }
    ‚Üì
Backend updates user_devices table
```

### **4. User Logout (Android App):**

```
User clicks Logout
    ‚Üì
Call API: DELETE /api/notifications/devices/{deviceId}
    ‚Üì
Backend marks device as inactive (is_active = false)
    ‚Üì
Clear local storage
```

---

## üìã IMPLEMENTATION CHECKLIST

### **PHASE 1: Backend Setup (Day 1-2)**

- [ ] **Create DTOs:**
  - [ ] `src/modules/notifications/dto/register-device.dto.ts`
  - [ ] `src/modules/notifications/dto/update-token.dto.ts`
  - [ ] `src/modules/notifications/dto/mark-read.dto.ts`

- [ ] **Update NotificationsService:**
  - [ ] Add `registerDevice()` method
  - [ ] Add `updateFCMToken()` method
  - [ ] Add `unregisterDevice()` method
  - [ ] Add `getUserDevices()` method
  - [ ] Add `getUserNotifications()` method
  - [ ] Add `markNotificationsAsRead()` method
  - [ ] Add `markAllNotificationsAsRead()` method
  - [ ] Add `deleteNotification()` method
  - [ ] Add `getNotificationStats()` method

- [ ] **Update FCMService:**
  - [ ] Add `validateToken()` method

- [ ] **Update NotificationsController:**
  - [ ] Add all 9 endpoints

- [ ] **Test Backend:**
  - [ ] Test v·ªõi Postman/HTTP client
  - [ ] Verify database records created correctly

---

### **PHASE 2: Android Setup (Day 3-4)**

- [ ] **Firebase Console:**
  - [ ] Create/Select Firebase project
  - [ ] Add Android app
  - [ ] Download `google-services.json`
  - [ ] Place in `app/` folder

- [ ] **build.gradle:**
  - [ ] Add Google Services plugin
  - [ ] Add Firebase dependencies

- [ ] **AndroidManifest.xml:**
  - [ ] Add permissions (INTERNET, POST_NOTIFICATIONS, WAKE_LOCK)
  - [ ] Register FirebaseMessagingService
  - [ ] Add notification metadata

- [ ] **Create NotificationChannels.kt:**
  - [ ] Define 6 channels
  - [ ] Create channels in Application.onCreate()

- [ ] **Create FirebaseMessagingService:**
  - [ ] Implement `onNewToken()`
  - [ ] Implement `onMessageReceived()`
  - [ ] Handle notification types
  - [ ] Create intents for click actions

- [ ] **MainActivity:**
  - [ ] Request POST_NOTIFICATIONS permission (Android 13+)
  - [ ] Get FCM token
  - [ ] Call register-device API
  - [ ] Save deviceId to SharedPreferences

- [ ] **Retrofit API:**
  - [ ] Create ApiService interface
  - [ ] Add all notification endpoints
  - [ ] Create request/response models

- [ ] **Logout Flow:**
  - [ ] Call unregister-device API
  - [ ] Clear local storage

---

### **PHASE 3: Testing (Day 5)**

- [ ] **Backend Testing:**
  - [ ] Test register-device with valid token
  - [ ] Test with invalid token (should fail)
  - [ ] Test get devices
  - [ ] Test update token
  - [ ] Test unregister device
  - [ ] Test get notifications
  - [ ] Test mark as read
  - [ ] Test delete notification

- [ ] **Android Testing:**
  - [ ] Test permission request flow
  - [ ] Test FCM token generation
  - [ ] Test register-device API call
  - [ ] Test receiving notifications (use Postman to trigger backend)
  - [ ] Test notification click ‚Üí open app
  - [ ] Test token refresh
  - [ ] Test logout ‚Üí unregister device

- [ ] **End-to-End Testing:**
  - [ ] Create task with assignee ‚Üí Assignee receives notification
  - [ ] Comment on task ‚Üí Task participants receive notification
  - [ ] Mention user ‚Üí Mentioned user receives HIGH priority notification
  - [ ] Move task ‚Üí Watchers receive notification
  - [ ] Check notification in app (mark as read, delete)

---

## üö® COMMON ISSUES & SOLUTIONS

### **Issue 1: Android kh√¥ng nh·∫≠n ƒë∆∞·ª£c notification**

**Possible Causes:**
- ‚ùå Permission POST_NOTIFICATIONS ch∆∞a ƒë∆∞·ª£c grant
- ‚ùå FCM token ch∆∞a ƒë∆∞·ª£c g·ª≠i l√™n backend
- ‚ùå Token kh√¥ng valid (ƒë√£ expired)
- ‚ùå Notification channel ch∆∞a ƒë∆∞·ª£c t·∫°o
- ‚ùå Firebase project configuration sai

**Debug Steps:**
```kotlin
// 1. Check permission
if (ContextCompat.checkSelfPermission(this, Manifest.permission.POST_NOTIFICATIONS) 
    == PackageManager.PERMISSION_GRANTED) {
    Log.d("DEBUG", "Permission granted")
}

// 2. Check FCM token
FirebaseMessaging.getInstance().token.addOnSuccessListener { token ->
    Log.d("DEBUG", "FCM Token: $token")
}

// 3. Check channels
val notificationManager = getSystemService(Context.NOTIFICATION_SERVICE) as NotificationManager
notificationManager.notificationChannels.forEach { channel ->
    Log.d("DEBUG", "Channel: ${channel.id}")
}
```

---

### **Issue 2: Backend validation fails "Invalid FCM token"**

**Possible Causes:**
- ‚ùå Token format sai
- ‚ùå Token t·ª´ wrong Firebase project
- ‚ùå Firebase Admin SDK credentials sai

**Solution:**
```typescript
// Check Firebase Admin initialization
const admin = require('firebase-admin');
console.log('Firebase App Name:', admin.app().name);

// Test token manually
try {
  await admin.messaging().send({
    token: 'YOUR_TEST_TOKEN',
    data: { test: 'validation' }
  }, true); // dry-run
  console.log('Token valid');
} catch (error) {
  console.error('Token invalid:', error.code);
}
```

---

### **Issue 3: Notification kh√¥ng hi·ªÉn th·ªã khi app ƒëang foreground**

**Solution:**
```kotlin
// Trong FirebaseMessagingService.onMessageReceived()
// Lu√¥n show notification manually, ngay c·∫£ khi app foreground

override fun onMessageReceived(message: RemoteMessage) {
    // Always show notification
    showNotification(
        title = message.notification?.title ?: "PlanTracker",
        body = message.notification?.body ?: "",
        // ...
    )
}
```

---

### **Issue 4: Token kh√¥ng ƒë∆∞·ª£c g·ª≠i l√™n backend sau khi login**

**Solution:**
```kotlin
// Trong login success callback
lifecycleScope.launch {
    // Wait for Firebase token
    val token = FirebaseMessaging.getInstance().token.await()
    
    // Then call register-device API
    registerDeviceWithBackend(token)
}
```

---

## üìö DOCUMENTATION REFERENCES

- **Android Client Setup:** `docs/FCM_ANDROID_CLIENT_SETUP.md` (900+ lines)
- **Backend Endpoints:** `docs/FCM_BACKEND_ENDPOINTS.md` (1200+ lines)
- **Backend Setup:** `docs/FCM_BACKEND_SETUP.md` (existing)
- **Notification Implementation Plan:** `docs/NOTIFICATION_IMPLEMENTATION_PLAN.md`
- **Render Cron Setup:** `docs/RENDER_CRON_SETUP_GUIDE.md`

---

## üéØ PRIORITY ACTIONS

### **Week 1 (CRITICAL):**
1. ‚úÖ Implement backend endpoints (Day 1-2)
2. ‚úÖ Setup Android Firebase SDK (Day 3)
3. ‚úÖ Implement FirebaseMessagingService (Day 4)
4. ‚úÖ Test end-to-end (Day 5)

### **Week 2:**
5. ‚úÖ Implement TASK_ASSIGNED notification (real-time)
6. ‚úÖ Implement TASK_COMMENTED notification
7. ‚úÖ Test with real users

---

## üí° TIPS

1. **Always validate FCM token** tr∆∞·ªõc khi save v√†o database
2. **Handle token refresh** - Firebase c√≥ th·ªÉ refresh token b·∫•t c·ª© l√∫c n√†o
3. **Mark device as inactive** instead of deleting khi logout (ƒë·ªÉ c√≥ history)
4. **Cleanup inactive devices** ƒë·ªãnh k·ª≥ (devices kh√¥ng active > 30 ng√†y)
5. **Use notification channels** ƒë·ªÉ user c√≥ th·ªÉ customize notification settings
6. **Test tr√™n real device** - Emulator c√≥ th·ªÉ kh√¥ng nh·∫≠n FCM messages

---

**Ready to implement?** Start with Backend endpoints first, then Android! üöÄ
